name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  test:
    name: Test before release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: '27'
        elixir-version: '1.18'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-release-${{ hashFiles('**/mix.lock') }}

    - name: Install dependencies
      run: mix deps.get

    - name: Compile project
      env:
        MIX_ENV: test
      run: mix compile --warnings-as-errors

    - name: Run tests
      env:
        MIX_ENV: test
      run: mix test

  publish:
    name: Publish to Hex.pm
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          # Extract version from tag (remove 'v' prefix)
          VERSION="${GITHUB_REF_NAME#v}"
        else
          # Use workflow dispatch input
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Setup Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: '27'
        elixir-version: '1.18'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-release-${{ hashFiles('**/mix.lock') }}

    - name: Install dependencies
      run: mix deps.get

    - name: Update version in mix.exs
      run: |
        sed -i "s/version: \".*\"/version: \"${{ steps.version.outputs.version }}\"/" mix.exs
        echo "Updated mix.exs:"
        grep "version:" mix.exs

    - name: Compile project
      env:
        MIX_ENV: prod
      run: mix compile

    - name: Generate documentation
      env:
        MIX_ENV: prod
      run: mix docs

    - name: Publish to Hex.pm
      env:
        MIX_ENV: prod
        HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
      run: mix hex.publish --yes

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        generate_release_notes: true
        body: |
          ## Concord v${{ steps.version.outputs.version }}

          ### Installation

          Add `concord` to your dependencies in `mix.exs`:

          ```elixir
          def deps do
            [
              {:concord, "~> ${{ steps.version.outputs.version }}"}
            ]
          end
          ```

          ### Documentation

          - [HexDocs](https://hexdocs.pm/concord/${{ steps.version.outputs.version }})
          - [Hex.pm Package](https://hex.pm/packages/concord/${{ steps.version.outputs.version }})

          ### Features

          - Distributed, strongly-consistent embedded key-value store
          - Raft consensus algorithm via Ra
          - 600K+ ops/sec performance
          - HTTP REST API with OpenAPI documentation
          - Token-based authentication and RBAC
          - TTL support, compression, and bulk operations
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, '-') }}
